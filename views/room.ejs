<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title><%= roomId %>호 - 직따</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        "primary": "#367d59",
                        "primary-dark": "#2a6346",
                        "background-light": "#FAFAFA",
                    },
                    fontFamily: {
                        "display": ["Noto Sans KR", "sans-serif"]
                    },
                    boxShadow: {
                        'soft': '0 8px 30px rgba(0,0,0,0.04)',
                        'card': '0 4px 20px rgba(0,0,0,0.02)',
                    }
                },
            },
        }
    </script>
    <style>
        body { min-height: 100dvh; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .ios-bottom-nav { padding-bottom: env(safe-area-inset-bottom); }
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
        .material-symbols-filled {
            font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
    </style>
</head>
<body class="bg-background-light font-display text-slate-800 overflow-x-hidden antialiased">
    <div class="relative flex min-h-screen w-full flex-col pb-32">
        <!-- Header -->
        <header class="sticky top-0 z-30 flex items-center justify-between bg-white/80 px-5 py-4 backdrop-blur-xl transition-all">
            <a href="/kennel/1" class="group flex size-10 items-center justify-center rounded-full bg-white shadow-sm ring-1 ring-gray-200 transition-all hover:scale-105 active:scale-95">
                <span class="material-symbols-outlined text-gray-700 transition-transform group-hover:-translate-x-0.5">arrow_back</span>
            </a>
            <div class="flex flex-col items-center">
                <h1 class="text-lg font-bold text-gray-900"><%= roomId %>호</h1>
            </div>
            <div class="w-10"></div>
        </header>

        <!-- Stats Section -->
        <section class="px-5 mt-2 mb-4">
            <div class="flex w-full items-center justify-between rounded-2xl bg-white px-6 py-3.5 shadow-sm ring-1 ring-black/5">
                <div class="flex flex-col items-center gap-0.5 flex-1 border-r border-gray-100 last:border-0">
                    <span class="text-[11px] font-medium text-gray-400">총 마리수</span>
                    <span id="totalCount" class="text-sm font-bold text-gray-900">0</span>
                </div>
                <div id="walkedStatContainer" class="flex flex-col items-center gap-0.5 flex-1 border-r border-gray-100 last:border-0 opacity-50">
                    <span class="text-[11px] font-medium text-gray-400">완료</span>
                    <span id="walkedCount" class="text-sm font-bold text-gray-900">0</span>
                </div>
                <div id="waitingStatContainer" class="flex flex-col items-center gap-0.5 flex-1">
                    <span class="text-[11px] font-medium text-orange-500/80">대기</span>
                    <span id="waitingCount" class="text-sm font-bold text-orange-500">0</span>
                </div>
            </div>
        </section>

        <!-- Dog List -->
        <main id="dogList" class="flex flex-col gap-5 px-5">
            <!-- Loading -->
            <div id="loading" class="flex justify-center py-8">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
            </div>
        </main>

        <!-- Room Navigation -->
        <div class="fixed bottom-[94px] left-0 right-0 z-20 flex justify-center pointer-events-none">
            <div class="pointer-events-auto flex items-center bg-white/95 backdrop-blur-md rounded-full shadow-[0_8px_30px_rgba(0,0,0,0.1)] ring-1 ring-black/5 p-1.5">
                <% if (roomId > 1) { %>
                <a href="/kennel/1/room/<%= roomId - 1 %>" class="flex items-center gap-2 pl-3 pr-4 py-2 rounded-full hover:bg-gray-100 transition-colors group">
                    <span class="material-symbols-outlined text-[18px] text-gray-400 group-hover:text-gray-700 transition-colors">arrow_back</span>
                    <span class="text-[11px] font-bold text-gray-600 group-hover:text-gray-900 transition-colors"><%= roomId - 1 %>호</span>
                </a>
                <% } else { %>
                <div class="pl-3 pr-4 py-2"></div>
                <% } %>
                <% if (roomId > 1 && roomId < 60) { %>
                <div class="w-px h-4 bg-gray-200 mx-1"></div>
                <% } %>
                <% if (roomId < 60) { %>
                <a href="/kennel/1/room/<%= roomId + 1 %>" class="flex items-center gap-2 pl-4 pr-3 py-2 rounded-full hover:bg-gray-100 transition-colors group">
                    <span class="text-[11px] font-bold text-gray-600 group-hover:text-gray-900 transition-colors"><%= roomId + 1 %>호</span>
                    <span class="material-symbols-outlined text-[18px] text-gray-400 group-hover:text-gray-700 transition-colors">arrow_forward</span>
                </a>
                <% } else { %>
                <div class="pl-4 pr-3 py-2"></div>
                <% } %>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <nav class="fixed bottom-0 left-0 right-0 z-50 bg-white/95 backdrop-blur-lg border-t border-slate-200 ios-bottom-nav">
            <div class="flex justify-around items-center max-w-md mx-auto pt-3 pb-4">
                <a href="/dashboard" class="flex-1 flex flex-col items-center gap-1 group">
                    <span class="material-symbols-outlined text-[26px] text-slate-400 transition-colors group-hover:text-primary">home</span>
                    <span class="text-[11px] font-semibold text-slate-400 transition-colors group-hover:text-primary">홈</span>
                </a>
                <a href="/kennel/1" class="flex-1 flex flex-col items-center gap-1 group">
                    <span class="material-symbols-filled text-[26px] text-primary">pets</span>
                    <span class="text-[11px] font-bold text-primary">견사</span>
                </a>
                <a href="/statistics" class="flex-1 flex flex-col items-center gap-1 group">
                    <span class="material-symbols-outlined text-[26px] text-slate-400 transition-colors group-hover:text-primary">bar_chart</span>
                    <span class="text-[11px] font-semibold text-slate-400 transition-colors group-hover:text-primary">통계</span>
                </a>
            </div>
        </nav>

        <!-- Gradient fade -->
        <div class="fixed bottom-0 left-0 right-0 z-10 h-32 bg-gradient-to-t from-white via-white/40 to-transparent pointer-events-none"></div>
    </div>

    <script>
        const roomId = <%= roomId %>;
        const S3_BASE_URL = 'https://jikddaz.s3.ap-northeast-2.amazonaws.com';

        let dogs = [];
        let walkStatus = {};

        function getTodayString() {
            const now = new Date();
            return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
        }

        function getLastWalkText(walks) {
            if (!walks || walks.length === 0) return '기록 없음';

            const sorted = [...walks].sort((a, b) => {
                const dateA = new Date(a.time.replace(' ', 'T'));
                const dateB = new Date(b.time.replace(' ', 'T'));
                return dateB - dateA;
            });

            const lastWalk = sorted[0];
            const lastWalkDate = new Date(lastWalk.time.replace(' ', 'T'));
            const now = new Date();
            const diffMs = now - lastWalkDate;
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

            if (diffHours < 1) return '방금 전';
            if (diffHours < 24) return `${diffHours}시간 전`;
            if (diffDays === 1) return '1일 전';
            return `${diffDays}일 전`;
        }

        async function loadDogs() {
            try {
                const res = await fetch(`/cage/${roomId}/dogs`);
                dogs = await res.json();

                const today = getTodayString();

                await Promise.all(dogs.map(async (dog) => {
                    try {
                        const walksRes = await fetch(`/cage/${roomId}/dogs/${dog.id}/walks`);
                        const walks = await walksRes.json();
                        const todayWalk = walks.find(w => w.time.startsWith(today));

                        walkStatus[dog.id] = {
                            walked: !!todayWalk,
                            walkTime: todayWalk ? todayWalk.time.split(' ')[1] : null,
                            walks: walks,
                            lastWalkText: getLastWalkText(walks)
                        };
                    } catch (e) {
                        walkStatus[dog.id] = { walked: false, walkTime: null, walks: [], lastWalkText: '기록 없음' };
                    }
                }));

                updateStats();
                renderDogs();
            } catch (err) {
                console.error('Error loading dogs:', err);
                document.getElementById('loading').innerHTML = '<p class="text-gray-500">데이터를 불러올 수 없습니다</p>';
            }
        }

        function updateStats() {
            const total = dogs.length;
            const walked = Object.values(walkStatus).filter(s => s.walked).length;
            const waiting = total - walked;

            document.getElementById('totalCount').textContent = total;
            document.getElementById('walkedCount').textContent = walked;
            document.getElementById('waitingCount').textContent = waiting;

            const walkedContainer = document.getElementById('walkedStatContainer');
            const waitingContainer = document.getElementById('waitingStatContainer');

            if (walked > 0) {
                walkedContainer.classList.remove('opacity-50');
            } else {
                walkedContainer.classList.add('opacity-50');
            }

            if (waiting === 0) {
                waitingContainer.classList.add('opacity-50');
            } else {
                waitingContainer.classList.remove('opacity-50');
            }
        }

        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function renderDogs() {
            const container = document.getElementById('dogList');
            const loadingEl = document.getElementById('loading');
            if (loadingEl) loadingEl.style.display = 'none';

            if (dogs.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 text-gray-400">
                        <span class="material-symbols-outlined text-[48px] mb-2">pets</span>
                        <p class="font-medium">등록된 강아지가 없습니다</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = dogs.map(dog => {
                const status = walkStatus[dog.id] || { walked: false, lastWalkText: '기록 없음' };
                const imgUrl = `${S3_BASE_URL}/cage_${roomId}_dog_${dog.id}_thumb.jpeg`;
                const dogNameEscaped = escapeHtml(dog.name);

                return `
                    <article class="group relative flex flex-col gap-5 rounded-[32px] bg-white p-5 shadow-[0_8px_24px_rgba(0,0,0,0.03)] ring-1 ring-gray-100 transition-all hover:shadow-[0_12px_32px_rgba(0,0,0,0.06)] hover:-translate-y-0.5">
                        <div class="flex items-center gap-5">
                            <!-- Image -->
                            <div class="relative size-20 shrink-0">
                                <img src="${imgUrl}"
                                     onerror="this.onerror=null; this.src='${S3_BASE_URL}/0_thumb.jpeg'"
                                     alt="${dogNameEscaped}"
                                     class="size-20 rounded-full object-cover ring-4 ring-gray-50">
                            </div>
                            <!-- Content -->
                            <div class="flex flex-1 flex-col justify-center">
                                <div class="flex items-center justify-between mb-1">
                                    <h3 class="text-xl font-bold text-gray-900">${dogNameEscaped}</h3>
                                    ${status.walked ? `
                                        <span class="inline-flex items-center rounded-full bg-emerald-50 px-2 py-0.5 text-[10px] font-bold text-emerald-600">
                                            완료
                                        </span>
                                    ` : ''}
                                </div>
                                <div class="mt-2 flex items-center gap-1 text-[11px] text-gray-400">
                                    <span class="material-symbols-outlined text-[14px] text-gray-400">schedule</span>
                                    <span>마지막 산책: <strong class="text-gray-600">${status.lastWalkText}</strong></span>
                                </div>
                                ${status.walked ? `
                                    <div class="mt-1 flex items-center gap-1 text-[11px] text-emerald-600">
                                        <span class="material-symbols-outlined text-[14px]">check_circle</span>
                                        <span>오늘 ${status.walkTime} 산책</span>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        <!-- Action Button -->
                        ${!status.walked ? `
                            <button class="walk-btn relative flex w-full items-center justify-center gap-2 overflow-hidden rounded-2xl bg-gradient-to-br from-[#367d59] to-[#255c40] py-4 text-sm font-bold text-white shadow-lg shadow-primary/20 transition-all hover:shadow-primary/30 active:scale-[0.98]"
                                    data-dog-id="${dog.id}"
                                    data-dog-name="${dogNameEscaped}">
                                <span class="material-symbols-outlined text-[20px]">pets</span>
                                산책 시작
                            </button>
                        ` : `
                            <div class="flex w-full items-center justify-center gap-2 rounded-2xl bg-gray-100 py-4 text-sm font-bold text-gray-400">
                                <span class="material-symbols-outlined text-[20px]">check_circle</span>
                                오늘 산책 완료
                            </div>
                        `}
                    </article>
                `;
            }).join('');
        }

        async function startWalk(dogId, dogName) {
            const result = await Swal.fire({
                title: `${dogName}`,
                text: '산책을 시작할까요?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#367d59',
                cancelButtonColor: '#94a3b8',
                confirmButtonText: '산책 시작',
                cancelButtonText: '취소'
            });

            if (!result.isConfirmed) return;

            const now = new Date();
            const time = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')} ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;

            const res = await fetch(`/cage/${roomId}/dogs/${dogId}/walk`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ time })
            });

            if (!res.ok) {
                Swal.fire('오류', '서버 오류가 발생했습니다', 'error');
                return;
            }

            walkStatus[dogId] = {
                walked: true,
                walkTime: time.split(' ')[1],
                walks: [...(walkStatus[dogId]?.walks || []), { time }],
                lastWalkText: '방금 전'
            };

            updateStats();
            renderDogs();

            Swal.fire({
                title: '산책 완료!',
                text: `${dogName} 산책이 기록되었습니다`,
                icon: 'success',
                timer: 1500,
                showConfirmButton: false
            });
        }

        // 이벤트 위임
        document.getElementById('dogList').addEventListener('click', (e) => {
            const btn = e.target.closest('.walk-btn');
            if (!btn) return;

            const dogId = btn.dataset.dogId;
            const dogName = btn.dataset.dogName;
            startWalk(dogId, dogName);
        });

        // 초기 로드
        loadDogs();
    </script>
</body>
</html>
