<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title><%= roomId %>호 - 직따</title>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        "primary": "#367d59",
                        "primary-dark": "#2a6245",
                        "background-light": "#f8f7f7",
                    },
                    fontFamily: {
                        "display": ["Be Vietnam Pro", "sans-serif"]
                    }
                },
            },
        }
    </script>
    <style>
        body { min-height: 100dvh; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .ios-bottom-nav { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="bg-background-light text-[#131614] font-display overflow-x-hidden antialiased">
    <div class="relative flex min-h-screen w-full flex-col pb-28">
        <!-- Header -->
        <header class="sticky top-0 z-30 flex items-center justify-between bg-background-light/95 px-4 py-4 backdrop-blur-md">
            <a href="/kennel/1" class="flex size-10 items-center justify-center rounded-full bg-white shadow-sm transition-transform active:scale-95 ring-1 ring-black/5">
                <span class="material-symbols-outlined text-[#131614]">arrow_back</span>
            </a>
            <div class="flex flex-col items-center">
                <h1 class="text-xl font-extrabold tracking-tight text-[#131614]"><%= roomId %>호</h1>
            </div>
            <div class="w-10"></div>
        </header>

        <!-- Stats Section -->
        <section class="px-4 pb-2 pt-2">
            <div class="flex w-full gap-3 overflow-x-auto no-scrollbar">
                <div class="flex min-w-[100px] flex-1 flex-col items-center justify-center gap-1 rounded-2xl bg-white p-3 shadow-sm ring-1 ring-black/5">
                    <span id="totalCount" class="text-2xl font-bold tracking-tight text-primary">0</span>
                    <span class="text-xs font-medium text-gray-500">총 마리수</span>
                </div>
                <div id="walkedStat" class="flex min-w-[100px] flex-1 flex-col items-center justify-center gap-1 rounded-2xl bg-white p-3 shadow-sm ring-1 ring-black/5 opacity-60 grayscale">
                    <span id="walkedCount" class="text-2xl font-bold tracking-tight text-gray-900">0</span>
                    <span class="text-xs font-medium text-gray-500">산책 완료</span>
                </div>
                <div id="waitingStat" class="flex min-w-[100px] flex-1 flex-col items-center justify-center gap-1 rounded-2xl bg-white p-3 shadow-sm ring-1 ring-black/5 bg-gradient-to-br from-white to-orange-50/50">
                    <span id="waitingCount" class="text-2xl font-bold tracking-tight text-orange-500">0</span>
                    <span class="text-xs font-medium text-gray-500">산책 대기</span>
                </div>
            </div>
        </section>

        <!-- Dog List -->
        <main id="dogList" class="flex flex-col gap-4 p-4">
            <!-- Loading -->
            <div id="loading" class="flex justify-center py-8">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
            </div>
        </main>

        <!-- Room Navigation -->
        <div class="fixed bottom-[90px] left-0 right-0 z-20 px-4 pointer-events-none">
            <div class="flex items-center justify-between pointer-events-auto w-full max-w-lg mx-auto">
                <!-- Previous Room -->
                <a href="/kennel/1/room/<%= Math.max(1, roomId - 1) %>"
                   class="group flex items-center gap-3 rounded-full bg-white py-3 pl-4 pr-6 shadow-[0_8px_30px_rgba(0,0,0,0.12)] transition-all hover:scale-105 active:scale-95 ring-1 ring-gray-100 <%= roomId <= 1 ? 'opacity-40 pointer-events-none' : '' %>">
                    <div class="flex size-8 items-center justify-center rounded-full bg-gray-50 group-hover:bg-primary/10 transition-colors">
                        <span class="material-symbols-outlined text-gray-500 group-hover:text-primary transition-colors text-lg">arrow_back</span>
                    </div>
                    <div class="flex flex-col items-start">
                        <span class="text-[10px] font-bold uppercase text-gray-400 tracking-wider">PREV</span>
                        <span class="text-sm font-bold text-[#131614] leading-tight"><%= roomId - 1 %>호</span>
                    </div>
                </a>
                <!-- Next Room -->
                <a href="/kennel/1/room/<%= Math.min(60, roomId + 1) %>"
                   class="group flex items-center gap-3 rounded-full bg-white py-3 pl-6 pr-4 shadow-[0_8px_30px_rgba(0,0,0,0.12)] transition-all hover:scale-105 active:scale-95 ring-1 ring-gray-100 <%= roomId >= 60 ? 'opacity-40 pointer-events-none' : '' %>">
                    <div class="flex flex-col items-end">
                        <span class="text-[10px] font-bold uppercase text-gray-400 tracking-wider">NEXT</span>
                        <span class="text-sm font-bold text-[#131614] leading-tight"><%= roomId + 1 %>호</span>
                    </div>
                    <div class="flex size-8 items-center justify-center rounded-full bg-gray-50 group-hover:bg-primary/10 transition-colors">
                        <span class="material-symbols-outlined text-gray-500 group-hover:text-primary transition-colors text-lg">arrow_forward</span>
                    </div>
                </a>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <nav class="fixed bottom-0 left-0 right-0 z-50 bg-white/95 backdrop-blur-lg border-t border-slate-200 ios-bottom-nav">
            <div class="flex justify-around items-center max-w-md mx-auto pt-3 pb-4">
                <a href="/dashboard" class="flex-1 flex flex-col items-center gap-1 group">
                    <span class="material-symbols-outlined text-[26px] text-slate-400 transition-colors group-hover:text-primary">home</span>
                    <span class="text-[11px] font-semibold text-slate-400 transition-colors group-hover:text-primary">홈</span>
                </a>
                <a href="/kennel/1" class="flex-1 flex flex-col items-center gap-1 group">
                    <span class="material-symbols-outlined text-[26px] text-primary" style="font-variation-settings: 'FILL' 1;">pets</span>
                    <span class="text-[11px] font-bold text-primary">견사</span>
                </a>
                <a href="/statistics" class="flex-1 flex flex-col items-center gap-1 group">
                    <span class="material-symbols-outlined text-[26px] text-slate-400 transition-colors group-hover:text-primary">bar_chart</span>
                    <span class="text-[11px] font-semibold text-slate-400 transition-colors group-hover:text-primary">통계</span>
                </a>
            </div>
            <div class="flex justify-center pb-2">
                <div class="w-32 h-1.5 bg-slate-200 rounded-full"></div>
            </div>
        </nav>

        <!-- Gradient fade -->
        <div class="fixed bottom-0 left-0 right-0 z-10 h-32 bg-gradient-to-t from-white/80 via-white/40 to-transparent pointer-events-none"></div>
    </div>

    <script>
        const roomId = <%= roomId %>;
        const S3_BASE_URL = 'https://jikddaz.s3.ap-northeast-2.amazonaws.com';

        let dogs = [];
        let walkStatus = {};

        function getTodayString() {
            const now = new Date();
            return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
        }

        function getLastWalkText(walks) {
            if (!walks || walks.length === 0) return '기록 없음';

            // 가장 최근 산책 찾기
            const sorted = [...walks].sort((a, b) => {
                const dateA = new Date(a.time.replace(' ', 'T'));
                const dateB = new Date(b.time.replace(' ', 'T'));
                return dateB - dateA;
            });

            const lastWalk = sorted[0];
            const lastWalkDate = new Date(lastWalk.time.replace(' ', 'T'));
            const now = new Date();
            const diffMs = now - lastWalkDate;
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

            if (diffHours < 1) return '방금 전';
            if (diffHours < 24) return `${diffHours}시간 전`;
            if (diffDays === 1) return '1일 전';
            return `${diffDays}일 전`;
        }

        async function loadDogs() {
            try {
                const res = await fetch(`/cage/${roomId}/dogs`);
                dogs = await res.json();

                const today = getTodayString();

                await Promise.all(dogs.map(async (dog) => {
                    try {
                        const walksRes = await fetch(`/cage/${roomId}/dogs/${dog.id}/walks`);
                        const walks = await walksRes.json();
                        const todayWalk = walks.find(w => w.time.startsWith(today));

                        walkStatus[dog.id] = {
                            walked: !!todayWalk,
                            walkTime: todayWalk ? todayWalk.time.split(' ')[1] : null,
                            walks: walks,
                            lastWalkText: getLastWalkText(walks)
                        };
                    } catch (e) {
                        walkStatus[dog.id] = { walked: false, walkTime: null, walks: [], lastWalkText: '기록 없음' };
                    }
                }));

                updateStats();
                renderDogs();
            } catch (err) {
                console.error('Error loading dogs:', err);
                document.getElementById('loading').innerHTML = '<p class="text-gray-500">데이터를 불러올 수 없습니다</p>';
            }
        }

        function updateStats() {
            const total = dogs.length;
            const walked = Object.values(walkStatus).filter(s => s.walked).length;
            const waiting = total - walked;

            document.getElementById('totalCount').textContent = total;
            document.getElementById('walkedCount').textContent = walked;
            document.getElementById('waitingCount').textContent = waiting;

            // 스타일 업데이트
            const walkedStat = document.getElementById('walkedStat');
            const waitingStat = document.getElementById('waitingStat');

            if (walked > 0) {
                walkedStat.classList.remove('opacity-60', 'grayscale');
            } else {
                walkedStat.classList.add('opacity-60', 'grayscale');
            }

            if (waiting === 0) {
                waitingStat.classList.add('opacity-60', 'grayscale');
                waitingStat.classList.remove('bg-gradient-to-br', 'from-white', 'to-orange-50/50');
            }
        }

        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function renderDogs() {
            const container = document.getElementById('dogList');
            const loadingEl = document.getElementById('loading');
            if (loadingEl) loadingEl.style.display = 'none';

            if (dogs.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 text-gray-400">
                        <span class="material-symbols-outlined text-[48px] mb-2">pets</span>
                        <p class="font-medium">등록된 강아지가 없습니다</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = dogs.map(dog => {
                const status = walkStatus[dog.id] || { walked: false, lastWalkText: '기록 없음' };
                const imgUrl = `${S3_BASE_URL}/cage_${roomId}_dog_${dog.id}_thumb.jpeg`;
                const dogNameEscaped = escapeHtml(dog.name);

                return `
                    <article class="group relative flex flex-col gap-4 rounded-3xl bg-white p-4 shadow-[0_2px_12px_rgba(0,0,0,0.06)] ring-1 ring-black/5 transition-all hover:shadow-lg">
                        <div class="flex items-start justify-between gap-4">
                            <!-- Image -->
                            <div class="relative size-24 shrink-0 overflow-hidden rounded-2xl bg-gray-100 shadow-inner">
                                <img src="${imgUrl}"
                                     onerror="this.onerror=null; this.src='${S3_BASE_URL}/0_thumb.jpeg'"
                                     alt="${dogNameEscaped}"
                                     class="h-full w-full object-cover transform transition-transform duration-500 group-hover:scale-110">
                            </div>
                            <!-- Content -->
                            <div class="flex flex-1 flex-col">
                                <div class="flex items-center justify-between">
                                    <h3 class="text-lg font-bold text-gray-900">${dogNameEscaped}</h3>
                                    ${status.walked ? `
                                        <span class="inline-flex items-center rounded-full bg-green-50 px-2.5 py-1 text-xs font-semibold text-green-700 ring-1 ring-inset ring-green-600/10">
                                            완료
                                        </span>
                                    ` : ''}
                                </div>
                                <div class="mt-3 flex items-center gap-1.5 text-xs text-gray-400">
                                    <span class="material-symbols-outlined text-[16px]" style="font-variation-settings: 'FILL' 1;">schedule</span>
                                    <span>마지막 산책: <strong class="text-gray-600">${status.lastWalkText}</strong></span>
                                </div>
                                ${status.walked ? `
                                    <div class="mt-1 flex items-center gap-1.5 text-xs text-green-600">
                                        <span class="material-symbols-outlined text-[16px]">check_circle</span>
                                        <span>오늘 ${status.walkTime} 산책 완료</span>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        <!-- Action Button -->
                        ${!status.walked ? `
                            <button class="walk-btn flex w-full items-center justify-center gap-2 rounded-xl bg-primary py-4 text-base font-bold text-white shadow-md shadow-primary/20 transition-all hover:bg-[#2d6b4b] active:scale-[0.98]"
                                    data-dog-id="${dog.id}"
                                    data-dog-name="${dogNameEscaped}">
                                <span class="material-symbols-outlined">pets</span>
                                산책 시작
                            </button>
                        ` : `
                            <div class="flex w-full items-center justify-center gap-2 rounded-xl bg-gray-100 py-4 text-base font-bold text-gray-400">
                                <span class="material-symbols-outlined">check_circle</span>
                                오늘 산책 완료
                            </div>
                        `}
                    </article>
                `;
            }).join('');
        }

        async function startWalk(dogId, dogName) {
            const result = await Swal.fire({
                title: `${dogName}`,
                text: '산책을 시작할까요?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#367d59',
                cancelButtonColor: '#94a3b8',
                confirmButtonText: '산책 시작',
                cancelButtonText: '취소'
            });

            if (!result.isConfirmed) return;

            const now = new Date();
            const time = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')} ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;

            const res = await fetch(`/cage/${roomId}/dogs/${dogId}/walk`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ time })
            });

            if (!res.ok) {
                Swal.fire('오류', '서버 오류가 발생했습니다', 'error');
                return;
            }

            walkStatus[dogId] = {
                walked: true,
                walkTime: time.split(' ')[1],
                walks: [...(walkStatus[dogId]?.walks || []), { time }],
                lastWalkText: '방금 전'
            };

            updateStats();
            renderDogs();

            Swal.fire({
                title: '산책 완료!',
                text: `${dogName} 산책이 기록되었습니다`,
                icon: 'success',
                timer: 1500,
                showConfirmButton: false
            });
        }

        // 이벤트 위임
        document.getElementById('dogList').addEventListener('click', (e) => {
            const btn = e.target.closest('.walk-btn');
            if (!btn) return;

            const dogId = btn.dataset.dogId;
            const dogName = btn.dataset.dogName;
            startWalk(dogId, dogName);
        });

        // 초기 로드
        loadDogs();
    </script>
</body>
</html>
